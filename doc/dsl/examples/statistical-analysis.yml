version: "0.1"

# Statistical Analysis Example for Risk Control
# Demonstrates comprehensive feature engineering and statistical analysis

# ========================================
# PART 1: Feature Extraction Pipeline
# ========================================

pipeline:
  # Define pipeline variables
  - vars:
      # Thresholds for association analysis
      max_devices_per_ip: 10
      max_users_per_ip: 5
      max_users_per_device: 3
      
      # Thresholds for velocity checks
      max_transactions_24h: 50
      max_login_velocity_ratio: 5
      
      # Time window definitions
      short_window: "5h"
      medium_window: "24h"
      long_window: "7d"
  
  # ========================================
  # Step 1: Comprehensive Feature Extraction
  # ========================================
  
  - type: extract
    id: statistical_features
    description: Extract comprehensive statistical features for risk analysis
    
    feature_groups:
      # ======================================
      # Group 1: User Behavioral Statistics
      # ======================================
      - group: user_behavior_stats
        description: User behavior patterns and statistics
        features:
          # Login statistics
          - name: login_count_7d
            value: count(user.logins, last_7d)
            description: Login count in the past 7 days
            
          - name: login_count_24h
            value: count(user.logins, last_24h)
            description: Login count in the past 24 hours
            
          - name: failed_login_count_24h
            value: count(user.failed_logins, last_24h)
            description: Failed login count in the past 24 hours
            
          - name: failed_login_ratio_7d
            value: |
              count(user.failed_logins, last_7d) / 
              max(count(user.logins, last_7d), 1)
            description: Failed login ratio in the past 7 days
            
          - name: avg_session_duration_30d
            value: avg(session.duration, {user.id == event.user.id}, last_30d)
            description: Average session duration in the past 30 days (seconds)
          
          # Transaction statistics
          - name: transaction_count_24h
            value: count(transactions, {user.id == event.user.id}, last_24h)
            description: Transaction count in the past 24 hours
            
          - name: transaction_count_7d
            value: count(transactions, {user.id == event.user.id}, last_7d)
            description: Transaction count in the past 7 days
            
          - name: transaction_sum_24h
            value: sum(transaction.amount, {user.id == event.user.id}, last_24h)
            description: Total transaction amount in the past 24 hours
            
          - name: transaction_sum_7d
            value: sum(transaction.amount, {user.id == event.user.id}, last_7d)
            description: Total transaction amount in the past 7 days
            
          - name: avg_transaction_30d
            value: avg(transaction.amount, {user.id == event.user.id}, last_30d)
            description: Average transaction amount in the past 30 days
            
          - name: median_transaction_30d
            value: median(transaction.amount, {user.id == event.user.id}, last_30d)
            description: Median transaction amount in the past 30 days
            
          - name: max_transaction_30d
            value: max(transaction.amount, {user.id == event.user.id}, last_30d)
            description: Maximum single transaction amount in the past 30 days
            
          - name: stddev_transaction_30d
            value: stddev(transaction.amount, {user.id == event.user.id}, last_30d)
            description: Standard deviation of transaction amounts in the past 30 days
      
      # ======================================
      # Group 2: Association Analysis
      # ======================================
      - group: association_analysis
        description: Entity relationship and association metrics
        features:
          # IP-based associations (core association analysis)
          - name: devices_per_ip_5h
            value: count_distinct(
                field: device.id,
                where: {geo.ip == event.geo.ip},
                window: last_5h
              )
            description: Number of device IDs associated with the same IP in the past 5 hours
            risk_threshold: 10
            risk_level: high
            
          - name: users_per_ip_5h
            value: count_distinct(
                field: user.id,
                where: {geo.ip == event.geo.ip},
                window: last_5h
              )
            description: Number of users associated with the same IP in the past 5 hours
            risk_threshold: 5
            risk_level: high
            
          - name: transactions_per_ip_5h
            value: count(
                transactions,
                where: {geo.ip == event.geo.ip},
                window: last_5h
              )
            description: Number of transactions from the same IP in the past 5 hours
            
          - name: countries_per_ip_24h
            value: count_distinct(
                field: geo.country,
                where: {geo.ip == event.geo.ip},
                window: last_24h
              )
            description: Number of countries associated with the same IP in the past 24 hours (IP proxy risk)
            risk_threshold: 3
            risk_level: medium
          
          # Device-based associations
          - name: users_per_device_24h
            value: count_distinct(
                field: user.id,
                where: {device.id == event.device.id},
                window: last_24h
              )
            description: Number of users associated with the same device in the past 24 hours
            risk_threshold: 3
            risk_level: high
            
          - name: ips_per_device_24h
            value: count_distinct(
                field: geo.ip,
                where: {device.id == event.device.id},
                window: last_24h
              )
            description: Number of IPs used by the same device in the past 24 hours
            risk_threshold: 10
            risk_level: medium
            
          - name: transactions_per_device_24h
            value: count(
                transactions,
                where: {device.id == event.device.id},
                window: last_24h
              )
            description: Number of transactions from the same device in the past 24 hours
          
          # User-based associations
          - name: devices_per_user_7d
            value: count_distinct(
                field: device.id,
                where: {user.id == event.user.id},
                window: last_7d
              )
            description: Number of devices used by the user in the past 7 days
            risk_threshold: 5
            risk_level: medium
            
          - name: ips_per_user_7d
            value: count_distinct(
                field: geo.ip,
                where: {user.id == event.user.id},
                window: last_7d
              )
            description: Number of IP addresses used by the user in the past 7 days
            risk_threshold: 20
            risk_level: medium
            
          - name: countries_per_user_7d
            value: count_distinct(
                field: geo.country,
                where: {user.id == event.user.id},
                window: last_7d
              )
            description: Number of countries accessed by the user in the past 7 days
            risk_threshold: 5
            risk_level: high
          
          # Identity reuse (identity information reuse detection)
          - name: users_per_phone_90d
            value: count_distinct(
                field: user.id,
                where: {user.phone == event.user.phone},
                window: last_90d
              )
            description: Number of users using the same phone number in the past 90 days
            risk_threshold: 3
            risk_level: critical
            
          - name: users_per_email_90d
            value: count_distinct(
                field: user.id,
                where: {user.email == event.user.email},
                window: last_90d
              )
            description: Number of users using the same email in the past 90 days
            risk_threshold: 2
            risk_level: critical
      
      # ======================================
      # Group 3: Temporal and Velocity Features
      # ======================================
      - group: temporal_velocity_features
        description: Time-based patterns and velocity metrics
        features:
          # Time since last event
          - name: hours_since_last_login
            value: hours_since(user.last_login_time)
            description: Hours since last login
            
          - name: days_since_last_transaction
            value: days_since(user.last_transaction_time)
            description: Days since last transaction
            
          - name: minutes_since_last_failed_login
            value: minutes_since(user.last_failed_login_time)
            description: Minutes since last failed login
          
          # Time patterns
          - name: is_off_hours
            value: hour(event.timestamp) >= 22 || hour(event.timestamp) <= 6
            description: Whether it is off-hours (10 PM to 6 AM)
            
          - name: is_weekend
            value: day_of_week(event.timestamp) in ["saturday", "sunday"]
            description: Whether it is weekend
            
          - name: current_hour
            value: hour(event.timestamp)
            description: Current hour (0-23)
          
          # Velocity metrics (speed/frequency change)
          - name: login_velocity_ratio
            value: |
              (count(logins, {user.id == event.user.id}, last_24h) / 
               max(count(logins, {user.id == event.user.id}, last_7d), 1)) * 7
            description: Login frequency change rate (24 hours vs 7-day average)
            risk_threshold: 5
            risk_level: medium
            
          - name: transaction_velocity_ratio
            value: |
              (count(transactions, {user.id == event.user.id}, last_24h) / 
               max(count(transactions, {user.id == event.user.id}, last_30d), 1)) * 30
            description: Transaction frequency change rate (24 hours vs 30-day average)
            risk_threshold: 5
            risk_level: medium
            
          - name: spending_velocity_24h
            value: sum(transaction.amounts, {user.id == event.user.id}, last_24h) / 24
            description: Spending speed (per hour)
            
          - name: rapid_transactions_5m
            value: count(transactions, {user.id == event.user.id}, last_5m)
            description: Number of transactions in the past 5 minutes (bot detection)
            risk_threshold: 3
            risk_level: high
      
      # ======================================
      # Group 4: Statistical Anomaly Detection
      # ======================================
      - group: statistical_anomaly_detection
        description: Statistical outlier and anomaly detection
        features:
          # Z-Score for transaction amount
          - name: transaction_amount_zscore
            value: |
              (event.transaction.amount - 
               avg(transaction.amount, {user.id == event.user.id}, last_30d)) /
              max(stddev(transaction.amount, {user.id == event.user.id}, last_30d), 1)
            description: Transaction amount Z-Score (standardized deviation)
            risk_threshold: 3
            risk_level: medium
          
          # Percentile-based outlier detection
          - name: is_amount_outlier_p95
            value: |
              event.transaction.amount > 
              percentile(transaction.amount, {user.id == event.user.id}, last_90d, p=95)
            description: Whether it is an abnormally large transaction above the 95th percentile
            
          - name: is_amount_outlier_p99
            value: |
              event.transaction.amount > 
              percentile(transaction.amount, {user.id == event.user.id}, last_90d, p=99)
            description: Whether it is an extremely large transaction above the 99th percentile
          
          # Deviation from normal patterns
          - name: transaction_amount_deviation_ratio
            value: |
              event.transaction.amount / 
              max(avg(transaction.amount, {user.id == event.user.id}, last_30d), 1)
            description: Ratio of current transaction amount to historical average
            risk_threshold: 5
            risk_level: medium
            
          - name: session_duration_deviation
            value: |
              abs(current_session_duration - 
                  avg(session.duration, {user.id == event.user.id}, last_30d)) /
              max(stddev(session.duration, {user.id == event.user.id}, last_30d), 1)
            description: Session duration deviation
      
      # ======================================
      # Group 5: Composite Risk Indicators
      # ======================================
      - group: composite_risk_indicators
        description: High-level composite risk indicators
        features:
          # Impossible travel detection
          - name: impossible_travel_indicator
            value: |
              distance(geo.location, user.last_login_location) / 
              max(hours_since(user.last_login_time), 0.1) > 800
            description: Impossible geographic location jump (>800km/h)
            risk_level: critical
            
          # New entity indicators
          - name: new_device_indicator
            value: device.id not_in user.known_devices
            description: Whether it is a new device
            
          - name: new_ip_indicator
            value: geo.ip not_in user.known_ips
            description: Whether it is a new IP address
            
          - name: new_geo_country_indicator
            value: geo.country != user.home_country
            description: Whether it is a login from a foreign country
          
          # Multi-dimensional risk
          - name: high_association_risk
            value: |
              count_distinct(user.id, {geo.ip == event.geo.ip}, last_5h) > 5 ||
              count_distinct(device.id, {geo.ip == event.geo.ip}, last_5h) > 10 ||
              count_distinct(user.id, {device.id == event.device.id}, last_24h) > 3
            description: High association risk (abnormal IP or device association)
            
          - name: high_velocity_risk
            value: |
              (count(logins, {user.id == event.user.id}, last_24h) / 
               max(count(logins, {user.id == event.user.id}, last_7d), 1)) * 7 > 5 ||
              count(transactions, {user.id == event.user.id}, last_5m) > 3
            description: High velocity risk (abnormal frequency)
            
          - name: suspicious_timing_pattern
            value: |
              (hour(event.timestamp) >= 22 || hour(event.timestamp) <= 6) &&
              hours_since(user.last_login_time) < 0.1
            description: Suspicious timing pattern (off-hours with very short login interval)
    
    # Cache configuration for performance
    cache:
      enabled: true
      ttl: 300  # 5 minutes
      key_template: "stats_features:{event.user.id}:{event.type}:{event.timestamp}"
      strategy: lazy
    
    # Output to context
    output: context.statistical_features
  
  # ========================================
  # Step 2: Parallel External Enrichment
  # ========================================
  
  - parallel:
      # IP reputation check
      - type: api
        id: ip_reputation
        endpoint: /api/ip/reputation
        params:
          ip: event.geo.ip
        cache:
          enabled: true
          ttl: 3600
        timeout: 2000
        on_error:
          action: fallback
          fallback:
            risk_score: 50
            
      # Device fingerprint analysis
      - type: api
        id: device_fingerprint
        endpoint: /api/device/analyze
        params:
          device_id: event.device.id
        cache:
          enabled: true
          ttl: 1800
        timeout: 2000
        on_error:
          action: fallback
          fallback:
            trust_score: 0.5
    
    merge:
      method: all
      on_partial_data:
        action: continue
        min_required: 1
  
  # ========================================
  # Step 3: Execute Rule-Based Detection
  # ========================================
  
  - include:
      ruleset: statistical_risk_detection

---

# ========================================
# PART 2: Rules Based on Statistical Features
# ========================================

# Rule 1: High IP-Device Association Risk
rule:
  id: high_ip_device_association
  name: High IP-Device Association Risk
  description: Detect IP addresses associated with too many devices
  
  when:
    event.type: login
    conditions:
      # Too many devices associated with the same IP in the past 5 hours
      - context.statistical_features.devices_per_ip_5h > vars.max_devices_per_ip
      # And also multiple users associated
      - context.statistical_features.users_per_ip_5h >= 3
      
  score: 80

---

# Rule 2: Device Sharing Risk
rule:
  id: device_sharing_risk
  name: Device Sharing Risk
  description: Detect devices shared by multiple users
  
  when:
    event.type: login
    conditions:
      # Multiple users associated with the same device in the past 24 hours
      - context.statistical_features.users_per_device_24h > vars.max_users_per_device
      # And the device uses multiple IPs
      - context.statistical_features.ips_per_device_24h > 5
      
  score: 70

---

# Rule 3: Abnormal User Velocity
rule:
  id: abnormal_user_velocity
  name: Abnormal User Velocity Pattern
  description: Detect unusual user activity velocity
  
  when:
    event.type: transaction
    conditions:
      # Login frequency suddenly increased by more than 5 times
      - context.statistical_features.login_velocity_ratio > vars.max_login_velocity_ratio
      # Or transaction frequency suddenly increased
      - context.statistical_features.transaction_velocity_ratio > 5
      
  score: 65

---

# Rule 4: Transaction Amount Anomaly
rule:
  id: transaction_amount_anomaly
  name: Transaction Amount Anomaly
  description: Detect unusual transaction amounts
  
  when:
    event.type: transaction
    conditions:
      # Z-Score exceeds 3 (statistical outlier)
      - any:
          - context.statistical_features.transaction_amount_zscore > 3
          # Or it is an extreme value above the 99th percentile
          - context.statistical_features.is_amount_outlier_p99 == true
          # Or it is more than 10 times the historical average
          - context.statistical_features.transaction_amount_deviation_ratio > 10
      
  score: 75

---

# Rule 5: Rapid Fire Transactions
rule:
  id: rapid_fire_transactions
  name: Rapid Fire Transactions (Bot Detection)
  description: Detect bot-like rapid transaction behavior
  
  when:
    event.type: transaction
    conditions:
      # Multiple transactions within 5 minutes (suspected bot)
      - context.statistical_features.rapid_transactions_5m >= 3
      # And abnormally high total transaction count in 24 hours
      - context.statistical_features.transaction_count_24h > vars.max_transactions_24h
      
  score: 85

---

# Rule 6: Identity Reuse Risk
rule:
  id: identity_reuse_risk
  name: Identity Information Reuse
  description: Detect reuse of identity information (phone/email)
  
  when:
    event.type: registration
    conditions:
      # Multiple accounts associated with the same phone number
      - any:
          - context.statistical_features.users_per_phone_90d > 3
          # Or multiple accounts associated with the same email
          - context.statistical_features.users_per_email_90d > 2
      
  score: 90

---

# Rule 7: Impossible Travel
rule:
  id: impossible_travel
  name: Impossible Travel Pattern
  description: Detect geographically impossible travel patterns
  
  when:
    event.type: login
    conditions:
      # Impossible geographic location jump
      - context.statistical_features.impossible_travel_indicator == true
      # And very short time since last login
      - context.statistical_features.hours_since_last_login < 2
      
  score: 95

---

# Rule 8: Suspicious Off-Hours Activity
rule:
  id: suspicious_off_hours_activity
  name: Suspicious Off-Hours Activity
  description: Detect suspicious activity during off-hours
  
  when:
    event.type: transaction
    conditions:
      # Off-hours
      - context.statistical_features.is_off_hours == true
      # And it is a new device or new IP
      - any:
          - context.statistical_features.new_device_indicator == true
          - context.statistical_features.new_ip_indicator == true
      # And large transaction amount
      - event.transaction.amount > 10000
      
  score: 60

---

# ========================================
# PART 3: Ruleset with Decision Logic
# ========================================

ruleset:
  id: statistical_risk_detection
  name: Statistical Risk Detection Ruleset
  description: Risk detection based on comprehensive statistical analysis
  
  rules:
    - high_ip_device_association
    - device_sharing_risk
    - abnormal_user_velocity
    - transaction_amount_anomaly
    - rapid_fire_transactions
    - identity_reuse_risk
    - impossible_travel
    - suspicious_off_hours_activity
  
  decision_logic:
    # Critical: Impossible travel or identity reuse
    - condition: |
        triggered_rules contains "impossible_travel" ||
        triggered_rules contains "identity_reuse_risk"
      action: deny
      reason: "Critical risk pattern detected"
      terminate: true
    
    # High: Multiple association risks
    - condition: |
        triggered_rules contains "high_ip_device_association" &&
        triggered_rules contains "device_sharing_risk"
      action: review
      reason: "Multiple association risk indicators"
    
    # High: Bot-like behavior
    - condition: triggered_rules contains "rapid_fire_transactions"
      action: deny
      reason: "Bot-like rapid transaction pattern"
      terminate: true
    
    # Medium-High: Very high score
    - condition: total_score >= 150
      action: deny
      reason: "Risk score too high: {total_score}"
    
    # Medium: High score with AI analysis
    - condition: total_score >= 100
      action: infer
      infer:
        data_snapshot:
          - event.*
          - context.statistical_features.*
          - context.statistical_risk_detection.*
      reason: "High risk score requires AI analysis: {total_score}"
    
    # Medium: Moderate score - manual review
    - condition: total_score >= 60
      action: review
      reason: "Moderate risk score: {total_score}"
    
    # Multiple triggers
    - condition: triggered_count >= 3
      action: review
      reason: "Multiple risk indicators ({triggered_count} rules triggered)"
    
    # Default: Approve
    - default: true
      action: approve
      reason: "No significant risk indicators"

---

# ========================================
# PART 4: Observability
# ========================================

observability:
  # Logging
  log:
    enabled: true
    level: info
    include:
      - event.user.id
      - event.type
      - context.statistical_features.devices_per_ip_5h
      - context.statistical_features.users_per_ip_5h
      - context.statistical_features.users_per_device_24h
      - context.statistical_features.login_velocity_ratio
      - context.statistical_features.transaction_velocity_ratio
      - context.statistical_risk_detection.action
      - context.statistical_risk_detection.total_score
      - context.statistical_risk_detection.triggered_rules
  
  # Metrics
  metrics:
    - name: risk_decisions_total
      type: counter
      labels:
        action: context.statistical_risk_detection.action
        event_type: event.type
        
    - name: risk_score_distribution
      type: histogram
      value: context.statistical_risk_detection.total_score
      buckets: [20, 40, 60, 80, 100, 120, 150, 200]
      
    - name: feature_distribution
      type: histogram
      dimensions:
        - name: devices_per_ip_5h
          value: context.statistical_features.devices_per_ip_5h
          buckets: [1, 3, 5, 10, 20, 50, 100]
          
        - name: users_per_device_24h
          value: context.statistical_features.users_per_device_24h
          buckets: [1, 2, 3, 5, 10, 20]
          
        - name: login_velocity_ratio
          value: context.statistical_features.login_velocity_ratio
          buckets: [0.5, 1, 2, 3, 5, 10, 20]
  
  # Tracing
  trace:
    enabled: true
    sample_rate: 1.0
    include_feature_values: true
